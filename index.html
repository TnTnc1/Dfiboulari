<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Le D√©fi Boulari ‚Äî Version R√©aliste</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@700&family=Handlee&family=Courier+Prime:wght@700&display=swap');

    :root{
      --glass: rgba(0,0,0,0.62);
      --glass2: rgba(255,255,255,0.92);
      --border: rgba(255,255,255,0.72);
      --shadow: rgba(0,0,0,0.35);
      --accent: #2d89ef;
      --good: #2ecc71;
      --warn: #f1c40f;
      --bad: #ff4757;
    }

    body{
      margin:0; padding:0; overflow:hidden;
      background:#0f0f10;
      font-family:'Roboto Condensed', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      touch-action:none;
      user-select:none;
    }

    #game-container{
      position:relative;
      width:100vw;
      height:100vh;
      overflow:hidden;
      background: url('https://i.postimg.cc/VL0sLRv5/IMG-3343.jpg') no-repeat center center;
      background-size:cover;
    }

    .game-overlay{
      position:absolute; inset:0;
      background: rgba(18,18,18,0.78);
      z-index:0;
    }

    canvas{
      display:block;
      width:100%;
      height:100%;
      position:relative;
      z-index:1;
    }

    /* UI layers */
    .ui-layer{ position:absolute; inset:0; pointer-events:none; display:flex; flex-direction:column; z-index:20; }
    .interactive{ pointer-events:auto; }
    .hidden{ display:none !important; }

    /* Rotate overlay */
    #rotateOverlay{
      display:none;
      position:fixed; inset:0;
      background:#0f0f10;
      color:#fff;
      z-index:9999;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      text-align:center;
      padding:20px;
    }
    @media screen and (orientation: portrait) and (max-width: 1024px){
      #rotateOverlay{ display:flex; }
      #gameUI, #startScreen, #endScreen{ display:none !important; }
    }

    /* Global buttons */
    .btn-round{
      position:absolute;
      width:50px; height:50px;
      border-radius:999px;
      display:flex; align-items:center; justify-content:center;
      background: rgba(255,255,255,0.95);
      border: 2px solid rgba(0,0,0,0.18);
      box-shadow: 0 12px 28px rgba(0,0,0,0.25);
      z-index:200;
      pointer-events:auto;
      cursor:pointer;
      font-size:22px;
    }
    .btn-mute{ top:16px; right:16px; }
    .btn-fullscreen{ top:16px; left:16px; }

    /* HUD */
    .hud-top{
      position:absolute; top:12px; left:12px; right:76px;
      display:flex; justify-content:space-between; align-items:flex-start;
      gap:10px;
    }
    .info-box{
      background: var(--glass);
      color:#fff;
      padding:10px 14px;
      border-radius:14px;
      border: 1px solid var(--border);
      box-shadow: 0 18px 60px var(--shadow);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      font-size:1.05rem;
    }
    .btn-quit{
      background:#e74c3c;
      color:#fff;
      padding:10px 14px;
      border-radius:14px;
      border: 1px solid rgba(255,255,255,0.75);
      box-shadow: 0 6px 0 #c0392b;
      cursor:pointer;
      pointer-events:auto;
      font-size:1rem;
      transition: transform .08s;
    }
    .btn-quit:active{ transform: translateY(2px); box-shadow:none; }

    .penalty-flash{ color: var(--bad); animation: flash 0.5s; }
    @keyframes flash{ 0%{ transform:scale(1);} 50%{ transform:scale(1.35);} 100%{ transform:scale(1);} }

    /* Consignes neutres */
    .hint-box{
      position:absolute;
      top:70px; left:12px;
      max-width:min(640px, 92vw);
      pointer-events:none;
    }
    .hint-inner{
      background: rgba(255,255,255,0.92);
      color:#111;
      padding:10px 12px;
      border-radius:16px;
      border: 1px solid rgba(0,0,0,0.12);
      box-shadow: 0 18px 70px rgba(0,0,0,0.25);
      display:flex; gap:10px; align-items:flex-start;
      font-family:'Handlee', cursive;
      font-weight:700;
      font-size:0.98rem;
    }
    .hint-icon{
      width:34px; height:34px;
      border-radius:12px;
      background: rgba(45,137,239,0.12);
      border: 1px solid rgba(45,137,239,0.22);
      display:flex; align-items:center; justify-content:center;
      font-size:18px;
      flex: 0 0 auto;
    }

    /* Feedback */
    .feedback-popup{
      position:absolute; top:42%; left:50%;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.86);
      color:#fff;
      padding:16px 18px;
      border-radius:16px;
      border: 1px solid rgba(255,255,255,0.7);
      box-shadow: 0 22px 80px rgba(0,0,0,0.45);
      text-align:center;
      pointer-events:none;
      animation: popIn .22s ease;
      min-width: 260px;
    }
    @keyframes popIn{
      from{ transform: translate(-50%,-50%) scale(0.92); opacity:0; }
      to{ transform: translate(-50%,-50%) scale(1); opacity:1; }
    }

    /* Controls */
    .controls-area{
      position:absolute; bottom:16px;
      width:100%;
      height:180px;
      display:flex;
      justify-content:space-between;
      padding:0 16px;
      pointer-events:none;
      gap:16px;
    }

    .wheel-zone{
      width:160px; height:160px;
      border-radius:50%;
      background: rgba(0,0,0,0.34);
      border: 1px solid rgba(255,255,255,0.30);
      box-shadow: 0 22px 70px rgba(0,0,0,0.35);
      backdrop-filter: blur(12px);
      pointer-events:auto;
      position:relative;
      align-self:flex-end;
    }
    .wheel-visual{
      width:100%; height:100%;
      border-radius:50%;
      position:relative;
      transition: transform 0.08s ease-out;
      background:
        radial-gradient(circle at center, rgba(255,255,255,0) 60%, rgba(255,255,255,0.18) 61%, rgba(255,255,255,0.08) 100%),
        linear-gradient(0deg, transparent 46%, rgba(255,255,255,0.14) 46%, rgba(255,255,255,0.14) 54%, transparent 54%),
        linear-gradient(90deg, transparent 46%, rgba(255,255,255,0.14) 46%, rgba(255,255,255,0.14) 54%, transparent 54%);
    }
    .wheel-visual::after{
      content:'';
      position:absolute; top:50%; left:50%;
      transform: translate(-50%,-50%);
      width:42px; height:42px;
      border-radius:50%;
      background: rgba(45,137,239,0.95);
      border: 2px solid rgba(255,255,255,0.9);
      box-shadow: 0 12px 30px rgba(0,0,0,0.25);
    }
    .wheel-knob{
      position:absolute;
      top:10px; left:50%;
      transform: translateX(-50%);
      width:26px; height:26px;
      border-radius:50%;
      background: rgba(45,137,239,0.95);
      border: 2px solid rgba(255,255,255,0.85);
      box-shadow: 0 12px 26px rgba(0,0,0,0.25);
    }

    .pedals-zone{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      justify-content:flex-end;
      gap:10px;
      pointer-events:auto;
    }
    .gear-stick{
      width:62px; height:62px;
      border-radius:14px;
      background: rgba(0,0,0,0.38);
      border: 1px solid rgba(255,255,255,0.30);
      color:#fff;
      display:flex; align-items:center; justify-content:center;
      font-size:1.5rem;
      cursor:pointer;
      box-shadow: 0 22px 70px rgba(0,0,0,0.30);
      backdrop-filter: blur(12px);
    }
    .gear-d{ background: rgba(46,204,113,0.26); }
    .gear-r{ background: rgba(231,112,85,0.26); }

    .pedal-row{ display:flex; gap:14px; }
    .pedal{
      width:76px; height:102px;
      border-radius:14px;
      border: 1px solid rgba(255,255,255,0.30);
      color:#fff;
      display:flex; align-items:center; justify-content:center;
      text-transform:uppercase;
      letter-spacing:.04em;
      font-size:1.05rem;
      cursor:pointer;
      transition: transform .08s;
      box-shadow: 0 22px 70px rgba(0,0,0,0.30);
      backdrop-filter: blur(12px);
    }
    .pedal:active, .pedal.active-key{ transform: translateY(5px); }
    .brake{ background: rgba(214,48,49,0.34); }
    .gas{ background: rgba(0,184,148,0.34); }

    @media (max-height: 520px){
      .controls-area{ height:140px; }
      .wheel-zone{ width:120px; height:120px; }
      .pedal{ width:64px; height:82px; font-size:.95rem; }
      .gear-stick{ width:52px; height:52px; font-size:1.2rem; }
    }

    /* Menus (NOUVEAUX ‚Äî pas V1) */
    .modal-bg{
      background: rgba(0,0,0,0.82);
      backdrop-filter: blur(14px);
      display:flex;
      justify-content:center;
      align-items:center;
    }
    .menu-card{
      background: rgba(255,255,255,0.96);
      border-radius:22px;
      width:min(540px, 94vw);
      padding:18px;
      box-shadow: 0 30px 100px rgba(0,0,0,0.55);
      border: 1px solid rgba(0,0,0,0.10);
      position:relative;
      text-align:left;
    }
    .menu-hero{
      border-radius:18px;
      overflow:hidden;
      border: 1px solid rgba(0,0,0,0.10);
      box-shadow: 0 12px 40px rgba(0,0,0,0.18);
    }
    .input-field{
      width:100%;
      padding:12px;
      border: 2px solid #dcdde1;
      border-radius:14px;
      font-size:1.15rem;
      text-align:center;
      font-family:'Handlee', cursive;
      background:#fff;
      margin-top:12px;
    }
    .btn-main{
      width:100%;
      border:none;
      border-radius:999px;
      padding:12px 18px;
      font-size:1.15rem;
      text-transform:uppercase;
      font-weight:800;
      letter-spacing:.04em;
      color:#fff;
      background: linear-gradient(to bottom, #3498db, #2980b9);
      box-shadow: 0 6px 0 #1c5980;
      cursor:pointer;
      transition: transform .08s;
      margin-top:12px;
    }
    .btn-main:active{ transform: translateY(4px); box-shadow:none; }

    /* Certificat */
    .certificate{
      background:#fffdf0;
      border: 8px double #2c3e50;
      padding:20px;
      position:relative;
      font-family:'Courier Prime', monospace;
      color:#333;
      box-shadow: 0 0 20px rgba(0,0,0,0.2);
      border-radius:14px;
    }
    .stamp{
      position:absolute;
      bottom:18px; right:18px;
      width:86px; height:86px;
      border:4px solid #c0392b;
      border-radius:50%;
      color:#c0392b;
      display:flex;
      justify-content:center;
      align-items:center;
      font-weight:bold;
      transform: rotate(-18deg);
      opacity:0.85;
      font-size:14px;
      text-align:center;
    }
  </style>
</head>

<body>
  <div id="rotateOverlay">
    <div class="text-6xl mb-4">üì±‚ÜîÔ∏è</div>
    <h1 class="text-2xl font-bold mb-2">TOURNEZ VOTRE APPAREIL</h1>
    <p>Le D√©fi Boulari se joue en mode paysage.</p>
  </div>

  <div id="game-container">
    <!-- Boutons globaux -->
    <button id="globalMuteBtn" class="btn-round btn-mute" title="Son">üîä</button>
    <button id="fsToggleBtn" class="btn-round btn-fullscreen" title="Plein √©cran">‚õ∂</button>

    <!-- Overlay sombre pendant le jeu -->
    <div id="gameOverlay" class="game-overlay hidden"></div>
    <canvas id="gameCanvas"></canvas>

    <!-- HUD jeu -->
    <div id="gameUI" class="ui-layer hidden">
      <div class="hud-top">
        <div class="flex items-center">
          <button id="quitBtn" class="btn-quit">‚úï Menu</button>
          <div class="info-box" id="levelName">√âpreuve 1</div>
        </div>
        <div class="info-box" style="color:var(--warn);">‚è±Ô∏è <span id="timerVal">00.00</span></div>
      </div>

      <div class="hint-box">
        <div class="hint-inner">
          <div class="hint-icon">üìù</div>
          <div>
            <div class="text-[12px] text-black/65 font-sans font-bold uppercase tracking-wide">Consigne</div>
            <div id="monitorMsg">Pr√©pare-toi‚Ä¶</div>
          </div>
        </div>
      </div>

      <div id="feedbackUI" class="feedback-popup hidden">
        <h2 class="text-2xl font-bold mb-1" id="fbTitle">OK</h2>
        <p class="text-base" id="fbText">...</p>
      </div>

      <!-- Controls -->
      <div class="controls-area">
        <div class="wheel-zone" id="wheelZone">
          <div id="wheelVisual" class="wheel-visual">
            <div class="wheel-knob"></div>
          </div>
        </div>

        <div class="pedals-zone">
          <div class="gear-stick gear-d" id="gearStick">D</div>
          <div class="pedal-row">
            <div class="pedal brake" id="btnBrake">Frein</div>
            <div class="pedal gas" id="btnGas">Gaz</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Menu accueil (NOUVEAU) -->
    <div id="startScreen" class="ui-layer interactive modal-bg">
      <div class="menu-card">
        <div class="menu-hero">
          <img src="https://i.postimg.cc/VL0sLRv5/IMG-3343.jpg" alt="Le D√©fi Boulari" class="w-full h-44 object-cover">
        </div>

        <div class="px-1 pt-4">
          <div class="flex items-center justify-between gap-3">
            <div>
              <div class="text-3xl font-extrabold text-slate-900 leading-tight">LE D√âFI BOULARI</div>
              <div class="text-slate-600 font-bold italic">Version r√©aliste ‚Äî 3 √©preuves</div>
            </div>
            <div class="rounded-2xl bg-blue-50 border border-blue-200 px-3 py-2 text-blue-700 font-extrabold">
              üéØ 1h offerte
            </div>
          </div>

          <div class="mt-3 grid grid-cols-3 gap-2">
            <div class="rounded-xl bg-slate-50 border border-slate-200 p-2 text-sm">
              <div class="font-extrabold text-slate-900">√âpreuve 1</div>
              <div class="text-slate-600">Feu</div>
            </div>
            <div class="rounded-xl bg-slate-50 border border-slate-200 p-2 text-sm">
              <div class="font-extrabold text-slate-900">√âpreuve 2</div>
              <div class="text-slate-600">Slalom</div>
            </div>
            <div class="rounded-xl bg-slate-50 border border-slate-200 p-2 text-sm">
              <div class="font-extrabold text-slate-900">√âpreuve 3</div>
              <div class="text-slate-600">Cr√©neau</div>
            </div>
          </div>

          <div class="mt-3 rounded-2xl bg-slate-50 border border-slate-200 p-3 text-sm text-slate-700">
            <div class="font-extrabold mb-1">R√®gles</div>
            <ul class="list-disc ml-4 space-y-1">
              <li>Le chrono d√©marre au <b>VERT</b> sur l‚Äô√©preuve 1.</li>
              <li>Choc = <b>+5s</b> ‚Ä¢ Porte slalom rat√©e = <b>+2s</b></li>
              <li>Objectif : rapide <b>et</b> pr√©cis.</li>
            </ul>
          </div>

          <input id="playerNameInput" class="input-field" placeholder="Ton pr√©nom / pseudo" maxlength="15">
          <button id="startBtn" class="btn-main">Commencer</button>

          <div class="mt-2 text-center text-xs text-slate-500">
            Clavier : ZQSD / fl√®ches + Espace/Shift (R/D)
          </div>
        </div>
      </div>
    </div>

    <!-- Fin -->
    <div id="endScreen" class="ui-layer interactive modal-bg hidden">
      <div class="menu-card" style="max-width:560px;">
        <div class="certificate">
          <h2 class="text-2xl font-bold text-center border-b-2 border-black pb-2 mb-4">PERMIS PROVISOIRE</h2>

          <div class="text-left space-y-2 text-sm">
            <p>PILOTE: <span class="font-bold text-lg" id="certName">---</span></p>
            <p>DATE: <span id="certDate">--/--/----</span></p>

            <div class="flex justify-between items-end mt-4 bg-gray-100 p-2 rounded">
              <div>
                <p class="text-xs text-gray-500">P√âNALIT√âS</p>
                <p class="text-red-600 font-bold text-xl" id="certPenalties">+0s</p>
              </div>
              <div class="text-right">
                <p class="text-xs text-gray-500">TEMPS FINAL</p>
                <p class="text-4xl font-bold text-blue-600" id="certTime">00.00</p>
              </div>
            </div>

            <div class="text-right text-xs text-gray-400 mt-2">ID: <span id="certId">#0000</span></div>
          </div>

          <div class="stamp">VALID√â<br>AUTO<br>√âCOLE</div>
        </div>

        <p class="text-gray-600 text-xs mt-4 mb-2 font-bold">üì∏ Capture d‚Äô√©cran et partage ton score !</p>
        <button class="btn-main" id="restartBtn" style="background:#27ae60; box-shadow:0 6px 0 #1f8a4f;">Rejouer</button>
      </div>
    </div>
  </div>

  <script>
    // ============================================================
    //  Le D√©fi Boulari ‚Äî Version r√©aliste (SANS vid√©o, SANS menus V1)
    // ============================================================

    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    // ----------------------------
    // Audio
    // ----------------------------
    let isMuted = false;

    function playSound(type) {
      if (!audioCtx || isMuted) return;

      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.connect(gain);
      gain.connect(audioCtx.destination);

      const now = audioCtx.currentTime;
      if (type === 'crash') {
        osc.type = 'sawtooth';
        osc.frequency.setValueAtTime(120, now);
        osc.frequency.exponentialRampToValueAtTime(30, now + 0.45);
        gain.gain.setValueAtTime(0.28, now);
        gain.gain.linearRampToValueAtTime(0, now + 0.45);
        osc.start(); osc.stop(now + 0.45);
      } else if (type === 'win') {
        osc.type = 'sine';
        osc.frequency.setValueAtTime(420, now);
        osc.frequency.linearRampToValueAtTime(860, now + 0.18);
        gain.gain.setValueAtTime(0.22, now);
        gain.gain.linearRampToValueAtTime(0, now + 0.18);
        osc.start(); osc.stop(now + 0.18);
      } else if (type === 'click') {
        osc.type = 'square';
        osc.frequency.setValueAtTime(220, now);
        gain.gain.setValueAtTime(0.12, now);
        gain.gain.linearRampToValueAtTime(0, now + 0.05);
        osc.start(); osc.stop(now + 0.05);
      }
    }

    function toggleMute(){
      isMuted = !isMuted;
      document.getElementById('globalMuteBtn').innerText = isMuted ? "üîá" : "üîä";
      if (isMuted) audioCtx.suspend(); else audioCtx.resume();
    }

    document.getElementById('globalMuteBtn').addEventListener('click', function(){
      toggleMute(); this.blur();
    });

    // ----------------------------
    // Fullscreen
    // ----------------------------
    function toggleFullScreen() {
      const doc = window.document;
      const docEl = doc.documentElement;
      const requestFullScreen = docEl.requestFullscreen || docEl.mozRequestFullScreen || docEl.webkitRequestFullScreen || docEl.msRequestFullscreen;
      const cancelFullScreen = doc.exitFullscreen || doc.mozCancelFullScreen || doc.webkitExitFullscreen || doc.msExitFullscreen;

      if (!doc.fullscreenElement && !doc.mozFullScreenElement && !doc.webkitFullscreenElement && !doc.msFullscreenElement) {
        if (requestFullScreen) requestFullScreen.call(docEl);
      } else {
        if (cancelFullScreen) cancelFullScreen.call(doc);
      }
    }

    document.getElementById('fsToggleBtn').addEventListener('click', function(){
      toggleFullScreen(); this.blur();
    });

    // ----------------------------
    // Assets (SVG inline)
    // ----------------------------
    let asphaltPattern;

    const carImg = new Image();
    carImg.src =
      "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='30' height='60' viewBox='0 0 30 60'%3E%3Cpath d='M3,12 Q3,6 9,6 L21,6 Q27,6 27,12 L27,51 Q27,57 21,57 L9,57 Q3,57 3,51 Z' fill='%23ffffff' stroke='%23bdc3c7' stroke-width='1'/%3E%3Crect x='5' y='15' width='20' height='9' rx='1' fill='%232c3e50'/%3E%3Crect x='5' y='39' width='20' height='7' rx='1' fill='%232c3e50'/%3E%3Crect x='3' y='6' width='5' height='3' rx='0.5' fill='%23f1c40f'/%3E%3Crect x='22' y='6' width='5' height='3' rx='0.5' fill='%23f1c40f'/%3E%3Crect x='3' y='54' width='5' height='3' rx='0.5' fill='%23e74c3c'/%3E%3Crect x='22' y='54' width='5' height='3' rx='0.5' fill='%23e74c3c'/%3E%3Ctext x='15' y='35' font-family='Arial' font-size='8' fill='%233498db' text-anchor='middle' transform='rotate(-90 15 35)'%3EAUTO-ECOLE%3C/text%3E%3Cpath d='M6,27 L24,27' stroke='rgba(0,0,0,0.1)' stroke-width='1'/%3E%3C/svg%3E";

    const carObsImg = new Image();
    carObsImg.src =
      "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='30' height='60' viewBox='0 0 30 60'%3E%3Cpath d='M3,12 Q3,6 9,6 L21,6 Q27,6 27,12 L27,51 Q27,57 21,57 L9,57 Q3,57 3,51 Z' fill='%23e74c3c' stroke='%23c0392b' stroke-width='1'/%3E%3Crect x='5' y='15' width='20' height='9' rx='1' fill='%232c3e50'/%3E%3Crect x='5' y='39' width='20' height='7' rx='1' fill='%232c3e50'/%3E%3C/svg%3E";

    const coneImg = new Image();
    coneImg.src =
      "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='22' height='22' viewBox='0 0 20 20'%3E%3Ccircle cx='10' cy='10' r='9' fill='%23e67e22' stroke='%23d35400' stroke-width='1'/%3E%3Ccircle cx='10' cy='10' r='5' fill='white'/%3E%3C/svg%3E";

    // ----------------------------
    // Params / state
    // ----------------------------
    const WHEELBASE = 40;
    const MAX_STEER = 0.6;

    let state = 'MENU'; // MENU, PLAYING, TRANSITION, FINISHED
    let currentLevel = 0;
    let playerName = "";

    // Chrono : d√©marre AU VERT (√©preuve 1)
    let startTime = 0;
    let timerRunning = false;

    let penaltyTime = 0;
    let winStartTime = 0;
    let gameLoopId = null;
    let lastCrashTime = 0;
    let hasReversed = false;

    let car = {
      x: 0, y: 0,
      angle: 0,
      speed: 0,
      steering: 0,
      gear: 1,
      inputs: { gas: false, brake: false, steerTarget: 0 }
    };

    let obstacles = [];
    let targetZone = null;

    const meta = {
      slalomGates: [],
      slalomLastX: 0,
      traffic: { phase: 'red', t0: 0, started: false }
    };

    const getCX = (pct) => canvas.width * (pct / 100);
    const getCY = (pct) => canvas.height * (pct / 100);

    // ----------------------------
    // UI helpers
    // ----------------------------
    function setMonitor(txt){ document.getElementById('monitorMsg').innerText = txt; }

    function showFeedback(title, text, colorTitle="#f1c40f") {
      const fb = document.getElementById('feedbackUI');
      document.getElementById('fbTitle').innerText = title;
      document.getElementById('fbText').innerText = text;
      document.getElementById('fbTitle').style.color = colorTitle;
      document.getElementById('fbText').style.color = "#fff";
      fb.classList.remove('hidden');
      setTimeout(() => fb.classList.add('hidden'), 850);
    }

    function flashTimer(){
      const t = document.getElementById('timerVal');
      t.classList.add('penalty-flash');
      setTimeout(()=> t.classList.remove('penalty-flash'), 500);
    }

    // ----------------------------
    // Levels
    // ----------------------------
    const LEVELS = [
      {
        title: "1. Le Feu",
        msg: "Attends le VERT, puis d√©marre et arr√™te-toi dans la zone.",
        setup: () => {
          const roadY = getCY(55);
          const roadH = 180;

          car.x = getCX(12);
          car.y = roadY + 40;
          car.angle = 0;

          targetZone = { x: getCX(70), y: roadY + 40, w: 95, h: 70, angle: 0 };

          obstacles.push({ type:'wall', x:getCX(50), y:roadY - roadH/2 - 10, w:getCX(100), h:20 });
          obstacles.push({ type:'wall', x:getCX(50), y:roadY + roadH/2 + 10, w:getCX(100), h:20 });

          meta.traffic.phase = 'red';
          meta.traffic.t0 = performance.now();
          meta.traffic.started = false;

          timerRunning = false;
          startTime = 0;

          setMonitor("Feu ROUGE‚Ä¶ attends. Le chrono d√©marre au VERT.");
        },
        update: () => {
          const t = (performance.now() - meta.traffic.t0) / 1000;
          if (t < 1.6) meta.traffic.phase = 'red';
          else if (t < 2.4) meta.traffic.phase = 'amber';
          else meta.traffic.phase = 'green';

          if (!meta.traffic.started) {
            if (meta.traffic.phase === 'green') {
              meta.traffic.started = true;
              timerRunning = true;
              startTime = Date.now();
              setMonitor("VERT ‚úÖ Go ! Arr√™te-toi dans la zone.");
              playSound('click');
            } else if (meta.traffic.phase === 'red') {
              setMonitor("Feu ROUGE‚Ä¶ attends.");
            } else {
              setMonitor("ORANGE‚Ä¶ pr√™t !");
            }
          }
        }
      },

      {
        title: "2. Le Slalom",
        msg: "Passe entre les 2 plots. Une porte sur deux, altern√©e haut/bas.",
        setup: () => {
          const roadY = getCY(55);
          const roadH = 220;

          car.x = getCX(10);
          car.y = roadY;
          car.angle = 0;

          targetZone = { x: getCX(90), y: roadY, w: 120, h: 90, angle: 0 };

          obstacles.push({ type:'wall', x:getCX(50), y:roadY - roadH/2 - 10, w:getCX(100), h:20 });
          obstacles.push({ type:'wall', x:getCX(50), y:roadY + roadH/2 + 10, w:getCX(100), h:20 });

          const gatesTotal = 10;
          const xStart = getCX(28);
          const xEnd = getCX(78);
          const offsetY = 70;
          const openingHalf = 45;
          const margin = 18;

          const roadTop = roadY - roadH/2 + margin;
          const roadBot = roadY + roadH/2 - margin;

          meta.slalomGates = [];
          meta.slalomLastX = car.x;

          let side = -1;
          for (let i=0;i<gatesTotal;i++){
            if (i % 2 === 1) continue;

            const tt = i / (gatesTotal - 1);
            const x = xStart + (xEnd - xStart) * tt;

            let openCenterY = roadY + side * offsetY;
            openCenterY = Math.max(roadTop + openingHalf, Math.min(roadBot - openingHalf, openCenterY));
            const yTop = openCenterY - openingHalf;
            const yBot = openCenterY + openingHalf;

            obstacles.push({ type:'cone', x, y:yTop });
            obstacles.push({ type:'cone', x, y:yBot });

            meta.slalomGates.push({ x, yTop, yBot, passed:false });
            side *= -1;
          }

          setMonitor("Slalom : vise l‚Äôouverture entre les 2 plots.");
        },
        update: () => {
          const lastX = meta.slalomLastX;
          const nowX = car.x;

          if (nowX > lastX) {
            for (const g of meta.slalomGates) {
              if (g.passed) continue;
              if (lastX <= g.x && nowX > g.x) {
                g.passed = true;
                const tol = 10;
                const ok = (car.y > g.yTop + tol && car.y < g.yBot - tol);
                if (!ok) {
                  penaltyTime += 2;
                  playSound('click');
                  flashTimer();
                  showFeedback("PORTE RAT√âE", "+2s ‚Äî passe entre les plots", "#f1c40f");
                }
              }
            }
          }
          meta.slalomLastX = nowX;
        }
      },

      {
        title: "3. Le Cr√©neau",
        msg: "Marche arri√®re obligatoire. Gare-toi dans la zone.",
        setup: () => {
          const roadY = getCY(62);

          car.x = getCX(12);
          car.y = roadY + 40;
          car.angle = 0;

          const targetX = getCX(55);
          targetZone = { x: targetX, y: roadY - 35, w: 100, h: 70, angle: 0 };

          obstacles.push({ type:'wall', x:getCX(50), y:roadY - 88, w:getCX(100), h:20 });

          obstacles.push({ type:'car', x: targetX - 120, y: roadY - 35, angle: -Math.PI/2 });
          obstacles.push({ type:'car', x: targetX + 120, y: roadY - 35, angle: -Math.PI/2 });

          setMonitor("Cr√©neau : passe en R puis rentre dans la zone.");
        }
      }
    ];

    // ----------------------------
    // Asphalt pattern + resize
    // ----------------------------
    function generateAsphalt(){
      const p = document.createElement('canvas');
      p.width = 96; p.height = 96;
      const g = p.getContext('2d');

      g.fillStyle = '#444';
      g.fillRect(0,0,96,96);

      for (let i=0;i<360;i++){
        const v = Math.random();
        g.fillStyle = v > 0.66 ? '#555' : (v > 0.33 ? '#3a3a3a' : '#2f2f2f');
        g.fillRect(Math.random()*96, Math.random()*96, 2, 2);
      }

      g.strokeStyle = 'rgba(255,255,255,0.04)';
      g.lineWidth = 1;
      for (let i=0;i<10;i++){
        g.beginPath();
        g.moveTo(Math.random()*96, Math.random()*96);
        g.lineTo(Math.random()*96, Math.random()*96);
        g.stroke();
      }

      asphaltPattern = ctx.createPattern(p, 'repeat');
    }

    function resize(){
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
      generateAsphalt();
    }
    window.addEventListener('resize', resize);
    resize();

    // ----------------------------
    // Game flow
    // ----------------------------
    function startGame(){
      const input = document.getElementById('playerNameInput');
      if (!input.value.trim()) { alert("Il faut un nom !"); return; }
      playerName = input.value.trim();

      if (audioCtx.state === 'suspended') audioCtx.resume();

      currentLevel = 0;
      penaltyTime = 0;
      winStartTime = 0;
      hasReversed = false;

      timerRunning = false;
      startTime = 0;

      loadLevel(0);

      document.getElementById('startScreen').classList.add('hidden');
      document.getElementById('endScreen').classList.add('hidden');
      document.getElementById('gameUI').classList.remove('hidden');
      document.getElementById('gameOverlay').classList.remove('hidden');

      if (!gameLoopId) {
        lastTime = performance.now();
        gameLoopId = requestAnimationFrame(animate);
      }
    }

    function quitGame(){
      if (confirm("Retour au menu ?")) {
        state = 'MENU';
        document.getElementById('gameUI').classList.add('hidden');
        document.getElementById('gameOverlay').classList.add('hidden');
        document.getElementById('startScreen').classList.remove('hidden');
      }
    }

    function loadLevel(idx){
      state = 'PLAYING';

      car.speed = 0;
      car.steering = 0;
      car.gear = 1;
      car.inputs.gas = false;
      car.inputs.brake = false;
      car.inputs.steerTarget = 0;
      updateGearUI();

      obstacles = [];
      targetZone = null;
      winStartTime = 0;
      lastCrashTime = 0;

      meta.slalomGates = [];
      meta.slalomLastX = 0;

      const lvl = LEVELS[idx];
      lvl.setup();

      document.getElementById('levelName').innerText = lvl.title;
      document.getElementById('feedbackUI').classList.add('hidden');
    }

    function nextLevel(){
      currentLevel++;
      if (currentLevel >= LEVELS.length) finishExam();
      else loadLevel(currentLevel);
    }

    function finishExam(){
      state = 'FINISHED';
      if (!startTime) startTime = Date.now(); // s√©curit√©

      const finalTime = (Date.now() - startTime) / 1000 + penaltyTime;
      const finalStr = finalTime.toFixed(2) + "s";

      document.getElementById('certName').innerText = playerName.toUpperCase();
      document.getElementById('certDate').innerText = new Date().toLocaleDateString();
      document.getElementById('certPenalties').innerText = "+" + penaltyTime.toFixed(0) + "s";
      document.getElementById('certTime').innerText = finalStr;
      document.getElementById('certId').innerText = "#" + Math.floor(Math.random()*9999).toString().padStart(4,"0");

      document.getElementById('gameUI').classList.add('hidden');
      document.getElementById('gameOverlay').classList.add('hidden');
      document.getElementById('endScreen').classList.remove('hidden');
    }

    // ----------------------------
    // Input
    // ----------------------------
    const keys = { up:false, down:false, left:false, right:false };

    window.addEventListener('keydown', (e)=>{
      if (['ArrowUp','ArrowDown','ArrowLeft','ArrowRight',' ','Shift','z','q','s','d'].includes(e.key)) e.preventDefault();
      switch(e.key){
        case 'ArrowLeft': case 'q': keys.left = true; break;
        case 'ArrowRight': case 'd': keys.right = true; break;
        case 'ArrowUp': case 'z': keys.up = true; break;
        case 'ArrowDown': case 's': keys.down = true; break;
        case ' ': case 'Shift': toggleGear(); break;
      }
    });

    window.addEventListener('keyup', (e)=>{
      switch(e.key){
        case 'ArrowLeft': case 'q': keys.left = false; break;
        case 'ArrowRight': case 'd': keys.right = false; break;
        case 'ArrowUp': case 'z': keys.up = false; break;
        case 'ArrowDown': case 's': keys.down = false; break;
      }
    });

    function toggleGear(){
      car.gear *= -1;
      updateGearUI();
      playSound('click');
    }

    function updateGearUI(){
      const stick = document.getElementById('gearStick');
      if (car.gear === 1) { stick.innerText = "D"; stick.className = "gear-stick gear-d"; }
      else { stick.innerText = "R"; stick.className = "gear-stick gear-r"; }
    }

    // Wheel
    const wheelZone = document.getElementById('wheelZone');
    const wheelVisual = document.getElementById('wheelVisual');
    let isSteering = false;
    let wheelTouchId = null;

    function handleSteer(cx, cy){
      const rect = wheelZone.getBoundingClientRect();
      const center_x = rect.left + rect.width/2;
      const center_y = rect.top + rect.height/2;
      const dx = cx - center_x;
      const dy = cy - center_y;

      let angle = Math.atan2(dy, dx) * (180/Math.PI);
      angle += 90;
      if (angle > 180) angle -= 360;
      if (angle < -180) angle += 360;

      const maxAngle = 110;
      angle = Math.max(-maxAngle, Math.min(maxAngle, angle));
      wheelVisual.style.transform = `rotate(${angle}deg)`;
      car.inputs.steerTarget = angle / maxAngle;
    }

    wheelZone.addEventListener('touchstart', (e)=>{
      e.preventDefault();
      const t = e.changedTouches[0];
      wheelTouchId = t.identifier;
      isSteering = true;
      handleSteer(t.clientX, t.clientY);
    }, {passive:false});

    wheelZone.addEventListener('touchmove', (e)=>{
      e.preventDefault();
      if (!isSteering) return;
      for (let i=0;i<e.changedTouches.length;i++){
        const t = e.changedTouches[i];
        if (t.identifier === wheelTouchId) handleSteer(t.clientX, t.clientY);
      }
    }, {passive:false});

    function endSteer(e){
      for (let i=0;i<e.changedTouches.length;i++){
        const t = e.changedTouches[i];
        if (t.identifier === wheelTouchId){
          isSteering = false;
          wheelTouchId = null;
          if (!keys.left && !keys.right){
            car.inputs.steerTarget = 0;
            wheelVisual.style.transform = "rotate(0deg)";
          }
        }
      }
    }
    wheelZone.addEventListener('touchend', endSteer);
    wheelZone.addEventListener('touchcancel', endSteer);

    wheelZone.addEventListener('mousedown', (e)=>{ isSteering=true; handleSteer(e.clientX, e.clientY); });
    window.addEventListener('mousemove', (e)=>{ if (isSteering) handleSteer(e.clientX, e.clientY); });
    window.addEventListener('mouseup', ()=>{ isSteering=false; if (!keys.left && !keys.right){ car.inputs.steerTarget=0; wheelVisual.style.transform="rotate(0deg)"; } });

    // Pedals
    const btnGas = document.getElementById('btnGas');
    const btnBrake = document.getElementById('btnBrake');
    const gearStick = document.getElementById('gearStick');

    btnGas.addEventListener('touchstart', (e)=>{ e.preventDefault(); car.inputs.gas=true; }, {passive:false});
    btnGas.addEventListener('touchend', (e)=>{ e.preventDefault(); car.inputs.gas=false; }, {passive:false});
    btnGas.addEventListener('mousedown', ()=> car.inputs.gas=true);
    btnGas.addEventListener('mouseup', ()=> car.inputs.gas=false);

    btnBrake.addEventListener('touchstart', (e)=>{ e.preventDefault(); car.inputs.brake=true; }, {passive:false});
    btnBrake.addEventListener('touchend', (e)=>{ e.preventDefault(); car.inputs.brake=false; }, {passive:false});
    btnBrake.addEventListener('mousedown', ()=> car.inputs.brake=true);
    btnBrake.addEventListener('mouseup', ()=> car.inputs.brake=false);

    gearStick.addEventListener('touchstart', (e)=>{ e.preventDefault(); toggleGear(); }, {passive:false});
    gearStick.addEventListener('mousedown', (e)=>{ e.preventDefault(); toggleGear(); });

    // Buttons
    document.getElementById('startBtn').addEventListener('click', startGame);
    document.getElementById('quitBtn').addEventListener('click', quitGame);
    document.getElementById('restartBtn').addEventListener('click', ()=>{
      document.getElementById('endScreen').classList.add('hidden');
      document.getElementById('startScreen').classList.remove('hidden');
      state = 'MENU';
    });

    // ----------------------------
    // Update / Draw
    // ----------------------------
    let lastTime = 0;

    function handleSteeringInput(dt){
      if (!isSteering) {
        if (keys.left) car.inputs.steerTarget = -1;
        else if (keys.right) car.inputs.steerTarget = 1;
        else car.inputs.steerTarget = 0;
        wheelVisual.style.transform = `rotate(${car.inputs.steerTarget * 120}deg)`;
      }

      const steerSpeed = 0.10 * dt;
      const target = car.inputs.steerTarget * MAX_STEER;
      if (car.steering < target) car.steering = Math.min(target, car.steering + steerSpeed);
      if (car.steering > target) car.steering = Math.max(target, car.steering - steerSpeed);
    }

    function update(dt){
      if (state !== 'PLAYING') return;

      const lvl = LEVELS[currentLevel];
      if (lvl.update) lvl.update(dt);

      let elapsed = 0;
      if (timerRunning && startTime) elapsed = (Date.now() - startTime) / 1000;
      elapsed += penaltyTime;
      document.getElementById('timerVal').innerText = elapsed.toFixed(2);

      handleSteeringInput(dt);

      const prevX = car.x, prevY = car.y, prevAngle = car.angle;

      const gas = car.inputs.gas || keys.up;
      const brake = car.inputs.brake || keys.down;

      if (car.gear === -1 && Math.abs(car.speed) > 0.12) hasReversed = true;

      if (gas) {
        if (car.gear === 1 && car.speed < 4.2) car.speed += 0.18 * dt;
        if (car.gear === -1 && car.speed > -2.4) car.speed -= 0.14 * dt;
      } else if (brake) {
        if (car.speed > 0.12) car.speed -= 0.30 * dt;
        else if (car.speed < -0.12) car.speed += 0.30 * dt;
        else car.speed = 0;
      } else {
        car.speed *= Math.pow(0.93, dt);
        if (Math.abs(car.speed) < 0.05) car.speed = 0;
      }

      if (Math.abs(car.speed) > 0.01) {
        const angularVelocity = (car.speed / WHEELBASE) * Math.tan(car.steering);
        car.angle += angularVelocity * dt;
        car.x += car.speed * Math.cos(car.angle) * dt;
        car.y += car.speed * Math.sin(car.angle) * dt;
      }

      if (checkCollisions()) {
        car.x = prevX; car.y = prevY; car.angle = prevAngle;
        car.speed = -car.speed * 0.5;
      }

      checkWin();
    }

    function getCarCorners(c){
      const cos = Math.cos(c.angle), sin = Math.sin(c.angle);
      const front = 30, back = 30, side = 15;
      return [
        { x: c.x + cos*front - sin*side, y: c.y + sin*front + cos*side },
        { x: c.x + cos*front + sin*side, y: c.y + sin*front - cos*side },
        { x: c.x - cos*back + sin*side, y: c.y - sin*back - cos*side },
        { x: c.x - cos*back - sin*side, y: c.y - sin*back + cos*side }
      ];
    }

    function checkCollisions(){
      const corners = getCarCorners(car);
      let hit = false;

      for (const obs of obstacles) {
        if (obs.type === 'cone') {
          for (const p of corners) if (Math.hypot(p.x - obs.x, p.y - obs.y) < 11) hit = true;
        } else {
          const w = obs.w || 30;
          const h = obs.h || 60;
          for (const p of corners) {
            if (p.x > obs.x - w/2 && p.x < obs.x + w/2 && p.y > obs.y - h/2 && p.y < obs.y + h/2) hit = true;
          }
        }

        if (hit) {
          if (Date.now() - lastCrashTime > 1000) crash("Choc ! +5s");
          return true;
        }
      }

      if (car.x < 0 || car.x > canvas.width || car.y < 0 || car.y > canvas.height) {
        if (Date.now() - lastCrashTime > 1000) crash("Sortie de route ! +5s");
        return true;
      }

      return false;
    }

    function crash(msg){
      lastCrashTime = Date.now();
      penaltyTime += 5;
      playSound('crash');
      flashTimer();
      setMonitor(msg);
      showFeedback("CHOC", "+5s", "#ff4757");
    }

    function isPointInTarget(p, t){
      let tx = p.x - t.x, ty = p.y - t.y;
      let cos = Math.cos(-t.angle), sin = Math.sin(-t.angle);
      let rx = tx*cos - ty*sin;
      let ry = tx*sin + ty*cos;
      const tol = 3;
      return (rx > (-t.w/2 - tol) && rx < (t.w/2 + tol) && ry > (-t.h/2 - tol) && ry < (t.h/2 + tol));
    }

    function checkWin(){
      if (!targetZone) return;
      if (Math.abs(car.speed) > 0.12) { winStartTime = 0; return; }

      const dx = car.x - targetZone.x;
      const dy = car.y - targetZone.y;
      const dist = Math.hypot(dx, dy);

      if (dist < 60) {
        if (winStartTime === 0) {
          if (currentLevel === 2 && !hasReversed) {
            setMonitor("Cr√©neau : passe en R au moins une fois.");
            return;
          }
          winStartTime = Date.now();
          setMonitor("Validation‚Ä¶ ne bouge plus ‚è≥");
        } else if (Date.now() - winStartTime > 1300) {
          const corners = getCarCorners(car);
          let cornersIn = 0;
          for (const p of corners) if (isPointInTarget(p, targetZone)) cornersIn++;

          let pPenalty = 0;
          if (cornersIn === 4) {
            showFeedback("PARFAIT ‚úÖ", "0s", "#2ecc71");
          } else {
            pPenalty = (4 - cornersIn) * 2;
            penaltyTime += pPenalty;
            showFeedback("VALID√â", `+${pPenalty}s (pr√©cision)`, "#f1c40f");
          }

          playSound('win');
          winStartTime = 0;
          state = 'TRANSITION';
          setTimeout(nextLevel, 900);
        }
      } else {
        winStartTime = 0;
      }
    }

    function draw(){
      if (state !== 'PLAYING') { ctx.clearRect(0,0,canvas.width, canvas.height); return; }

      ctx.fillStyle = asphaltPattern || '#555';
      ctx.fillRect(0,0,canvas.width, canvas.height);

      if (currentLevel === 0) drawRoadHorizontal(getCY(55), 180, true);
      if (currentLevel === 1) drawRoadHorizontal(getCY(55), 220, false);
      if (currentLevel === 2) drawCreneauScene(getCY(62));

      if (targetZone) {
        ctx.save();
        ctx.translate(targetZone.x, targetZone.y);
        ctx.rotate(targetZone.angle);
        ctx.strokeStyle = 'rgba(46,204,113,0.95)';
        ctx.lineWidth = 4;
        ctx.setLineDash([10,10]);
        ctx.strokeRect(-targetZone.w/2, -targetZone.h/2, targetZone.w, targetZone.h);
        ctx.fillStyle = 'rgba(46,204,113,0.18)';
        ctx.fillRect(-targetZone.w/2, -targetZone.h/2, targetZone.w, targetZone.h);
        ctx.setLineDash([]);
        ctx.restore();
      }

      for (const obs of obstacles) {
        if (obs.type === 'cone') ctx.drawImage(coneImg, obs.x - 11, obs.y - 11, 22, 22);
        else if (obs.type === 'wall') {
          ctx.fillStyle = 'rgba(220,220,220,0.88)';
          ctx.fillRect(obs.x - obs.w/2, obs.y - obs.h/2, obs.w, obs.h);
          ctx.strokeStyle = 'rgba(90,90,90,0.65)';
          ctx.strokeRect(obs.x - obs.w/2, obs.y - obs.h/2, obs.w, obs.h);
        } else if (obs.type === 'car') {
          ctx.save();
          ctx.translate(obs.x, obs.y);
          if (obs.angle) ctx.rotate(obs.angle);
          ctx.drawImage(carObsImg, -15, -30, 30, 60);
          ctx.restore();
        }
      }

      if (currentLevel === 0) drawTrafficLight(getCX(62), getCY(55) - 110);
      drawCar();
    }

    function drawRoadHorizontal(roadY, roadH, withStopLine){
      ctx.fillStyle = 'rgba(0,0,0,0.16)';
      ctx.fillRect(0, roadY - roadH/2, canvas.width, roadH);

      ctx.strokeStyle = 'rgba(255,255,255,0.85)';
      ctx.lineWidth = 4;
      ctx.setLineDash([18,18]);
      ctx.beginPath(); ctx.moveTo(0, roadY); ctx.lineTo(canvas.width, roadY); ctx.stroke();
      ctx.setLineDash([]);

      if (withStopLine){
        ctx.strokeStyle = 'rgba(255,255,255,0.92)';
        ctx.lineWidth = 8;
        ctx.beginPath();
        ctx.moveTo(getCX(60), roadY + 10);
        ctx.lineTo(getCX(60), roadY + roadH/2 - 10);
        ctx.stroke();
      }
    }

    function drawCreneauScene(roadY){
      ctx.fillStyle = 'rgba(0,0,0,0.16)';
      ctx.fillRect(0, 0, canvas.width, 130 + roadY);

      const curbY = roadY - 78;
      ctx.fillStyle = 'rgba(220,220,220,0.85)';
      ctx.fillRect(0, 0, canvas.width, curbY);

      ctx.strokeStyle = 'rgba(255,255,255,0.85)';
      ctx.lineWidth = 4;
      ctx.setLineDash([18,18]);
      ctx.beginPath(); ctx.moveTo(0, roadY + 20); ctx.lineTo(canvas.width, roadY + 20); ctx.stroke();
      ctx.setLineDash([]);
    }

    function drawTrafficLight(x, y){
      ctx.save();
      ctx.translate(x,y);

      ctx.fillStyle = 'rgba(20,20,20,0.86)';
      ctx.strokeStyle = 'rgba(255,255,255,0.18)';
      ctx.lineWidth = 2;
      roundRect(-20, -40, 40, 80, 10, true, true);

      const phase = meta.traffic.phase;
      lamp(0,-22, phase==='red' ? '#ff3b30' : 'rgba(255,59,48,0.18)');
      lamp(0,0, phase==='amber' ? '#ffcc00' : 'rgba(255,204,0,0.18)');
      lamp(0,22, phase==='green' ? '#34c759' : 'rgba(52,199,89,0.18)');

      ctx.restore();

      function lamp(cx, cy, color){
        ctx.beginPath();
        ctx.fillStyle = color;
        ctx.arc(cx, cy, 10, 0, Math.PI*2);
        ctx.fill();
        ctx.strokeStyle = 'rgba(255,255,255,0.12)';
        ctx.stroke();
      }

      function roundRect(x,y,w,h,r,fill,stroke){
        ctx.beginPath();
        ctx.moveTo(x+r, y);
        ctx.lineTo(x+w-r, y);
        ctx.quadraticCurveTo(x+w, y, x+w, y+r);
        ctx.lineTo(x+w, y+h-r);
        ctx.quadraticCurveTo(x+w, y+h, x+w-r, y+h);
        ctx.lineTo(x+r, y+h);
        ctx.quadraticCurveTo(x, y+h, x, y+h-r);
        ctx.lineTo(x, y+r);
        ctx.quadraticCurveTo(x, y, x+r, y);
        ctx.closePath();
        if (fill) ctx.fill();
        if (stroke) ctx.stroke();
      }
    }

    function drawCar(){
      ctx.save();
      ctx.translate(car.x, car.y);
      ctx.rotate(car.angle + Math.PI/2);

      if (Date.now() - lastCrashTime < 900 && Math.floor(Date.now()/120)%2===0) ctx.globalAlpha = 0.55;

      // ombre
      ctx.fillStyle = 'rgba(0,0,0,0.20)';
      ctx.beginPath();
      ctx.ellipse(0, 6, 14, 18, 0, 0, Math.PI*2);
      ctx.fill();

      // roues
      ctx.fillStyle = '#000';
      ctx.fillRect(-14, 15, 6, 12);
      ctx.fillRect(8, 15, 6, 12);
      ctx.save(); ctx.translate(-11, -20); ctx.rotate(car.steering); ctx.fillRect(-3, -6, 6, 12); ctx.restore();
      ctx.save(); ctx.translate(11, -20); ctx.rotate(car.steering); ctx.fillRect(-3, -6, 6, 12); ctx.restore();

      ctx.drawImage(carImg, -15, -30, 30, 60);

      if (car.inputs.brake || keys.down){
        ctx.fillStyle = 'rgba(255,0,0,0.6)';
        ctx.shadowColor = 'rgba(255,0,0,0.65)';
        ctx.shadowBlur = 16;
        ctx.fillRect(-12, 26, 6, 3);
        ctx.fillRect(6, 26, 6, 3);
        ctx.shadowBlur = 0;
      }
      if (car.gear === -1){
        ctx.fillStyle = 'rgba(255,255,255,0.85)';
        ctx.fillRect(-8, 26, 4, 3);
      }

      ctx.restore();
    }

    function animate(t){
      gameLoopId = requestAnimationFrame(animate);
      if (!lastTime) { lastTime = t; return; }
      const dt = (t - lastTime) / 16.67;
      lastTime = t;
      update(dt);
      draw();
    }

    // ----------------------------
    // Boot
    // ----------------------------
    function boot(){
      // Menu d√©j√† visible (startScreen sans hidden)
      document.getElementById('gameUI').classList.add('hidden');
      document.getElementById('gameOverlay').classList.add('hidden');
    }
    boot();
  </script>
</body>
</html>
